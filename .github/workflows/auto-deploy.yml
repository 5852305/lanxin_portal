# .github/workflows/auto-deploy.yml

name: auto deploy ğŸš€

on:
  # ç›‘å¬pushæ“ä½œ
  push:
    branches:
      - master # è¿™é‡Œåªé…ç½®äº†masteråˆ†æ”¯ï¼Œæ‰€ä»¥åªæœ‰æ¨é€masteråˆ†æ”¯æ‰ä¼šè§¦å‘ä»¥ä¸‹ä»»åŠ¡
  pull_request:

  # è¿™ä¸ªé€‰é¡¹å¯ä»¥ä½¿ä½ æ‰‹åŠ¨åœ¨ Action tab é¡µé¢è§¦å‘å·¥ä½œæµ
  # workflow_dispatch:

permissions:
  # å…è®¸å¯¹ä»“åº“çš„å†…å®¹è¿›è¡Œå†™æ“ä½œã€‚åŒ…æ‹¬åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤æ–‡ä»¶ã€ç›®å½•ä»¥åŠæäº¤æ›´æ”¹ç­‰
  # è¿™é‡Œåªé…ç½®äº†pushï¼Œæ‰€ä»¥åªæœ‰æ¨é€mainåˆ†æ”¯æ‰ä¼šè§¦å‘ä»¥ä¸‹ä»»åŠ¡
  contents: write
  # å…è®¸ç®¡ç† GitHub Pages æœåŠ¡å¹¶å¯¹å…¶è¿›è¡Œå†™æ“ä½œ
  pages: write


jobs:
  # ä»»åŠ¡ID
  build-and-deploy:
    # è¿è¡Œç¯å¢ƒ
    # runs-on: macos-latest
    # runs-on: windows-latest
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}

    # æ­¥éª¤
    steps:
      # å®˜æ–¹actionï¼Œå°†ä»£ç æ‹‰å–åˆ°è™šæ‹Ÿæœº
      - name: Checkout
        uses: actions/checkout@v3

      # å»ºä¸€ä¸ªåä¸ºsetup-nodeçš„æ­¥éª¤ï¼ˆå®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Node.jsï¼‰
      - name: setup-node
        # ä½¿ç”¨setup-node@v3è¿™ä¸ªaction
        uses: actions/setup-node@v3
        # æŒ‡å®šæŸä¸ªaction å¯èƒ½éœ€è¦è¾“å…¥çš„å‚æ•°
        with:
          node-version: '18.x'

      # å®‰è£… pnpm
      - name: å®‰è£… pnpm
        run: npm install -g pnpm@6.32.3

      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm i
      # æ‰“åŒ…
      - name: æ‰“åŒ… ğŸ”§
        run: pnpm run build

      # æ‰“åŒ…å‹ç¼©åŒ…
      - name: æ‰“åŒ…å‹ç¼©åŒ… ğŸ”§
        run: tar -zcvf nuxt.tar.gz ./app/.output

      - name: ä¸Šä¼ å‹ç¼©åŒ…è‡³æœåŠ¡å™¨ # ä¸Šä¼ å‹ç¼©åŒ…è‡³æœåŠ¡å™¨
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }} # è‹¥ä½¿ç”¨å¯†é’¥åˆ™åˆ é™¤æœ¬è¡Œ
          port: ${{ secrets.SFTP_PORT }}
          source: "nuxt.tar.gz"
          target: ${{ secrets.SERVER_DESTINATION }}

      - name: è§£å‹æ‰“åŒ…åº”ç”¨ #
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }} # è‹¥ä½¿ç”¨å¯†é’¥åˆ™åˆ é™¤æœ¬è¡Œ
          port: ${{ secrets.SFTP_PORT }} # è‹¥ä½¿ç”¨å¯†é’¥åˆ™åˆ é™¤æœ¬è¡Œ
          script: |
            cd ${{ secrets.SERVER_DESTINATION }}
            tar -zxvf nuxt.tar.gz -C ./
            mv nuxt/* .
            rm -rf nuxt.tar.gz
      - name: é‡å¯Docker #
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SFTP_SERVER }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }} # è‹¥ä½¿ç”¨å¯†é’¥åˆ™åˆ é™¤æœ¬è¡Œ
          port: ${{ secrets.SFTP_PORT }} # è‹¥ä½¿ç”¨å¯†é’¥åˆ™åˆ é™¤æœ¬è¡Œ
          script: |
            docker compose -f  ${{ secrets.DOCKER_FILE }} down
            docker compose -f  ${{ secrets.DOCKER_FILE }}  up -d
